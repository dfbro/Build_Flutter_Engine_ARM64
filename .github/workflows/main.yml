name: Main

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Dart SDK git ref
        required: true
        type: string
        default: main

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      src-path: flutter-engine
    steps:
      - name: Checkout Flutter Engine
        uses: actions/checkout@v4

      - name: Maximize build space
        uses: easimon/maximize-build-space@v4
        with:
          root-reserve-mb: 2048
          swap-size-mb: 4096
          remove-dotnet: true
          remove-haskell: true
          remove-android: true

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            zip git python3 python3-pip ninja-build cmake \
            g++-aarch64-linux-gnu g++-arm-linux-gnueabihf \
            g++-multilib gcc-multilib unzip wget curl

      - name: Ensure depot_tools on PATH
        run: |
          if [ ! -d depot_tools ]; then
            git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          fi
          echo "$PWD/depot_tools" >> $GITHUB_PATH
          export PATH="$PWD/depot_tools:$PATH"

      - name: Sync Flutter Engine & Dart
        run: |
          rm -rf flutter-engine
          mkdir flutter-engine
          echo "solutions = [{" > flutter-engine/.gclient
          echo "  \"managed\": False," >> flutter-engine/.gclient
          echo "  \"name\": \"src/flutter\"," >> flutter-engine/.gclient
          echo "  \"url\": \"https://github.com/flutter/engine\"," >> flutter-engine/.gclient
          echo "  \"custom_deps\": {}," >> flutter-engine/.gclient
          echo "  \"deps_file\": \"DEPS\"," >> flutter-engine/.gclient
          echo "  \"safesync_url\": \"\"" >> flutter-engine/.gclient
          echo "}]" >> flutter-engine/.gclient

          cd flutter-engine
          export DEPOT_TOOLS_UPDATE=0
          gclient sync --with_branch_heads --with_tags --reset --jobs 16

          cd src/flutter
          git fetch --tags
          git checkout 3.27.4 || true
          cd ../..
          gclient runhooks

      - name: Fetch Dart pub dependencies
        run: |
          cd flutter-engine/src/flutter
          export PATH="$PWD/third_party/dart/tools/sdks/dart-sdk/bin:$PATH"
          dart pub get --suppress-analytics

      - name: Upload source artifact
        uses: actions/upload-artifact@v5
        with:
          name: src
          path: flutter-engine

  build:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - platform: linux
            target-arch: x64
          - platform: linux
            target-arch: arm64
          - platform: linux
            target-arch: arm
          # Android
          - platform: android
            target-arch: arm64
          - platform: android
            target-arch: arm
          - platform: android
            target-arch: riscv64

    steps:
      - name: Download synced source
        uses: actions/download-artifact@v5
        with:
          name: src
          path: .

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            zip git python3 python3-pip ninja-build cmake \
            g++-aarch64-linux-gnu g++-arm-linux-gnueabihf \
            g++-multilib gcc-multilib unzip wget curl

      - name: Setup multiarch
        run: |
          case ${{ matrix.target-arch }} in
            arm)
              sudo dpkg --add-architecture armhf
              sudo apt-get update
              sudo apt-get install -y libc6:armhf
              ;;
            arm64)
              sudo dpkg --add-architecture arm64
              sudo apt-get update
              sudo apt-get install -y libc6:arm64
              ;;
          esac

      - name: Setup Android NDK
        if: matrix.platform == 'android'
        run: |
          NDK_VERSION=r25b
          wget https://dl.google.com/android/repository/android-ndk-$NDK_VERSION-linux.zip
          unzip android-ndk-$NDK_VERSION-linux.zip
          export ANDROID_NDK_HOME=$PWD/android-ndk-$NDK_VERSION
          export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH

      - name: Build Dart/Flutter SDK
        run: |
          cd flutter-engine/src/sdk

          if [ "${{ matrix.platform }}" = "linux" ]; then
            # Build host tools for cross compilation
            if [ "${{ matrix.target-arch }}" != "x64" ]; then
              ./tools/build.py --mode release --os linux --arch x64 create_sdk
            fi
            ./tools/build.py --mode release --os linux --arch ${{ matrix.target-arch }} create_sdk
          else
            ./tools/build.py --mode release --os android --arch ${{ matrix.target-arch }} create_sdk
          fi

      - name: Archive output
        run: |
          OUT_NAME="dartsdk-${{ matrix.platform }}-${{ matrix.target-arch }}-3.27.4.tar.gz"
          tar -czf "$OUT_NAME" -C flutter-engine/src/sdk/out/Release* -- dart-sdk

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: dartsdk-${{ matrix.platform }}-${{ matrix.target-arch }}-3.27.4
          path: dartsdk-${{ matrix.platform }}-${{ matrix.target-arch }}-3.27.4.tar.gz
